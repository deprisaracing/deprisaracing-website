<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>一次性分房抽签（静态页面）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;padding:20px;background:#f6f9fc;color:#111}
    .card{background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,50,0.08);padding:18px;max-width:760px;margin:14px auto}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 12px;color:#555}
    .admin{border-left:4px solid #3b82f6;padding-left:12px}
    .hint{font-size:13px;color:#666}
    label{display:block;margin-top:8px;font-weight:600;font-size:13px}
    input[type=text], textarea{width:100%;padding:8px;border:1px solid #e6eef8;border-radius:6px;box-sizing:border-box}
    button{background:#3b82f6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;margin-top:10px}
    button:disabled{opacity:.5;cursor:not-allowed}
    .codes{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .codeBox{background:#f3f7ff;border:1px dashed #d7e6ff;padding:8px;border-radius:8px;font-family:monospace}
    .result{background:#fcffef;border:1px solid #f2f8d8;padding:12px;border-radius:8px;margin-top:12px}
    .used{opacity:.5;text-decoration:line-through}
    .small{font-size:13px;color:#666}
    footer{font-size:13px;color:#777;text-align:center;margin-top:18px}
    .danger{color:#a00;font-weight:700}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    .export{white-space:pre-wrap;background:#f8f8f8;padding:8px;border-radius:6px;border:1px solid #e9e9e9}
  </style>
</head>
<body>
  <div class="card">
    <h1>一次性线上分房（静态页面）</h1>
    <p class="lead">使用说明：管理员把每个人的 <strong>一次性 code</strong> 私下发给他们。参与者在页面输入 code 即可查看自己的房间和同房伙伴。页面没有后台，所有逻辑都在浏览器中运行。</p>

    <div class="admin">
      <label>管理员面板 — 配置参与者名单（请务必保证为 8 人）</label>
      <textarea id="namesInput" rows="4" placeholder='示例: 一行一个名字，长度 8 行
例如：
Alice
Bob
Charlie
David
Eve
Frank
Grace
Heidi'></textarea>
      <div class="flex">
        <button id="generateBtn">生成 codes → 显示给每个人并导出映射（仅管理员）</button>
        <button id="resetBtn" style="background:#ef4444">重置</button>
      </div>
      <p class="hint">生成后会在下方显示 8 个一次性 code（你要把每个 code 私下发给对应的人）。页面会把 code 对应关系以混淆方式内嵌在网页中（在“导出映射”区域），参会者无法在页面上看到其他人的分配。</p>

      <div id="adminArea" style="margin-top:12px;display:none">
        <label>为每个人生成的一次性 code（请私下发给他们）</label>
        <div id="codes" class="codes"></div>

        <label style="margin-top:8px">导出映射（管理员保存这段 JSON 到安全处；也可以把整个页面 HTML 保存为静态文件并部署）</label>
        <div id="exportJson" class="export small"></div>
      </div>
    </div>

    <hr style="margin:18px 0">

    <div>
      <label>参与者面板 — 输入你收到的一次性 code：</label>
      <input id="codeInput" type="text" placeholder="在这里粘贴你的 code（区分大小写）" />
      <button id="revealBtn">揭晓我的房间</button>

      <div id="result" class="result" style="display:none"></div>

      <p class="hint" style="margin-top:8px">提示：一次性 code 只能揭晓一次。请管理员把 code 私下发给每个人（例如私讯、私聊）。</p>
    </div>

    <hr style="margin:18px 0">

    <div class="small">
      <strong>重要安全说明：</strong>
      <ul>
        <li>此页面是 <em>纯静态</em>、无后台的工具：分配关系被嵌入页面脚本中（混淆过），但任何懂技术的人仍可查看源码获得映射。若你担心这种情况，请只把部署好的页面 URL 给参与者，并将每个 code 私下单独私信发送。</li>
        <li>若你需要更高安全（无人可查看源码），需要一个简单的后端服务来在服务器端保存 mapping 并且每个 code 只能被揭晓一次。</li>
      </ul>
    </div>

    <footer>页面作者：自动分房小工具 · 使用前请备份原始名单</footer>
  </div>

<script>
/*
Static single-file "one-time code" assignment tool.
Usage:
1) 管理员在 namesInput 中逐行填入 8 个名字，点击「生成」。
2) 管理员把生成的 8 个 code 私下分别发给对应的人（例如 DM）。
3) 参与者打开同一页面，粘贴他们收到的 code，点击「揭晓我的房间」查看自己的房号与同房者。
Note: 由于为静态前端，若你担心源码可见请采用私下托管并谨慎分发 codes。
*/

// ---- Configuration / helper ----
const utils = {
  randHex(len=6){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s },
  b64enc(s){ return btoa(unescape(encodeURIComponent(s))) },
  b64dec(s){ try{return decodeURIComponent(escape(atob(s))) }catch(e){return null} }
};

const generateMapping = (names) => {
  // names: array of 8 names
  // generate 8 codes, and pair them into 4 rooms (2 per room)
  const codes = [];
  for(let i=0;i<8;i++) codes.push(utils.randHex(6));
  // shuffle names
  const shuffled = names.slice();
  for(let i=shuffled.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  // pair up sequentially -> room1: index 0+1, room2: 2+3, etc
  const mapping = {}; // code -> {room: n, name: name}
  for(let i=0;i<8;i++){
    const room = Math.floor(i/2)+1; // 1..4
    mapping[codes[i]] = { room: room, name: shuffled[i] };
  }
  return { codes, mapping, shuffled };
};

// ---- UI ----
const namesInput = document.getElementById('namesInput');
const generateBtn = document.getElementById('generateBtn');
const resetBtn = document.getElementById('resetBtn');
const adminArea = document.getElementById('adminArea');
const codesDiv = document.getElementById('codes');
const exportJson = document.getElementById('exportJson');
const codeInput = document.getElementById('codeInput');
const revealBtn = document.getElementById('revealBtn');
const resultDiv = document.getElementById('result');

let currentState = null; // {codes:[], mapping:{code: {room,name}}, used: {code:true}, createdAt:...}

// Load state from hardcoded embedded map if present (for page reuse)
function loadEmbedded() {
  if(window.__ASSIGNMENT_EMBEDDED__) {
    try {
      currentState = window.__ASSIGNMENT_EMBEDDED__;
      // mark used map if absent
      if(!currentState.used) currentState.used = {};
      showAdminArea();
    } catch(e){ console.warn('无法载入嵌入映射') }
  }
}

function showAdminArea(){
  adminArea.style.display='block';
  codesDiv.innerHTML='';
  currentState.codes.forEach(c=>{
    const el = document.createElement('div');
    el.className='codeBox';
    el.innerHTML = `<div style="font-weight:700">${c}</div><div class="small">发送给：<em>${currentState.mapping[c].name}</em></div><div class="small">房间：<strong>房 ${currentState.mapping[c].room}</strong></div>`;
    codesDiv.appendChild(el);
  });
  exportJson.textContent = JSON.stringify(currentState);
}

// Generate button
generateBtn.addEventListener('click', ()=>{
  const raw = namesInput.value.trim();
  if(!raw){ alert('请先把 8 个人的名字逐行填入'); return; }
  const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length !== 8){ if(!confirm(`你输入了 ${lines.length} 名。当前工具预期 8 人。\n确定要继续吗？（继续将以当前人数生成配对）`)) return; }
  const {codes, mapping, shuffled} = generateMapping(lines);
  currentState = { codes, mapping, used: {}, createdAt: (new Date()).toISOString() };
  // To make mapping not trivially visible, we'll also produce an embedded token (base64 of mapping)
  // but we show direct mapping to admin only in adminArea.
  showAdminArea();
  alert('已生成 codes。请把每个 code 私下发给对应的人（不要在群里公开）。\n你也可以复制「导出映射」并保存备份。');
});

// Reset
resetBtn.addEventListener('click', ()=>{
  if(!confirm('确定要清空当前配置吗？')) return;
  currentState = null;
  adminArea.style.display='none';
  codesDiv.innerHTML='';
  exportJson.textContent='';
  namesInput.value='';
  resultDiv.style.display='none';
});

// Reveal
revealBtn.addEventListener('click', ()=>{
  const code = (codeInput.value || '').trim();
  if(!code){ alert('请输入一次性 code'); return; }
  if(!currentState){
    // Try to load embedded mapping from the page variable (if the page was exported)
    if(window.__ASSIGNMENT_EMBEDDED__){
      currentState = window.__ASSIGNMENT_EMBEDDED__;
      if(!currentState.used) currentState.used = {};
    } else {
      alert('当前页面尚未配置分房映射（管理员需要先生成并把映射嵌入页面或部署一份已生成的页面）。请联系管理员。');
      return;
    }
  }
  const entry = currentState.mapping[code];
  if(!entry){
    alert('无效的 code 或 code 已被使用。请确认你收到的 code 是正确的并联系管理员（不要在群内公开 code）。');
    return;
  }
  if(currentState.used && currentState.used[code]){
    alert('此 code 已被使用（已揭晓）。若你需要帮助请联系管理员。');
    return;
  }
  // reveal: show room and partner
  // find partner: same room, different code
  const room = entry.room;
  const partners = [];
  for(const [c,v] of Object.entries(currentState.mapping)){
    if(v.room === room && c !== code) partners.push(v.name);
  }
  currentState.used[code] = true; // mark used locally
  resultDiv.style.display='block';
  resultDiv.innerHTML = `<div style="font-size:16px;font-weight:700">你被分配到：房 ${room}</div>
    <div style="margin-top:8px">你的同房者：<strong>${partners.join(', ') || '（未知）'}</strong></div>
    <div class="small" style="margin-top:8px;color:#555">提示：此 code 已标记为已使用（仅保存在此页面的内存）。若你需要管理员在后台记录，请把使用记录发给管理员。</div>`;
});

// Allow admins to paste an exported JSON to embed mapping to page (optional)
(function embedImportShortcut(){
  // If page URL contains ?embed=BASE64JSON, auto-load it
  try {
    const params = new URLSearchParams(window.location.search);
    if(params.has('embed')){
      const raw = params.get('embed');
      try {
        const json = utils.b64dec(raw);
        const obj = JSON.parse(json);
        // basic validation
        if(obj && obj.codes && obj.mapping){
          window.__ASSIGNMENT_EMBEDDED__ = obj;
          currentState = obj;
          if(!currentState.used) currentState.used = {};
          showAdminArea();
          console.log('已载入嵌入映射（来自 URL param embed）');
        }
      } catch(e){}
    }
  } catch(e){}
})();
</script>
</body>
</html>




